'use strict';

/**
 * Responsible for loading / finding Mocha's "rc" files.
<<<<<<< HEAD
=======
 * This doesn't have anything to do with `mocha.opts`.
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
 *
 * @private
 * @module
 */

const fs = require('fs');
const path = require('path');
const debug = require('debug')('mocha:cli:config');
const findUp = require('find-up');
<<<<<<< HEAD
const {createUnparsableFileError} = require('../errors');
const utils = require('../utils');
=======
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a

/**
 * These are the valid config files, in order of precedence;
 * e.g., if `.mocharc.js` is present, then `.mocharc.yaml` and the rest
 * will be ignored.
 * The user should still be able to explicitly specify a file.
 * @private
 */
exports.CONFIG_FILES = [
<<<<<<< HEAD
  '.mocharc.cjs',
=======
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
  '.mocharc.js',
  '.mocharc.yaml',
  '.mocharc.yml',
  '.mocharc.jsonc',
  '.mocharc.json'
];

<<<<<<< HEAD
=======
const isModuleNotFoundError = err =>
  err.code !== 'MODULE_NOT_FOUND' ||
  err.message.indexOf('Cannot find module') !== -1;

>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
/**
 * Parsers for various config filetypes. Each accepts a filepath and
 * returns an object (but could throw)
 */
const parsers = (exports.parsers = {
<<<<<<< HEAD
  yaml: filepath => require('js-yaml').load(fs.readFileSync(filepath, 'utf8')),
  js: filepath => {
    let cwdFilepath;
    try {
      debug('parsers: load cwd-relative path: "%s"', path.resolve(filepath));
      cwdFilepath = require.resolve(path.resolve(filepath)); // evtl. throws
      return require(cwdFilepath);
    } catch (err) {
      if (cwdFilepath) throw err;

      debug('parsers: retry load as module-relative path: "%s"', filepath);
      return require(filepath);
=======
  yaml: filepath =>
    require('js-yaml').safeLoad(fs.readFileSync(filepath, 'utf8')),
  js: filepath => {
    const cwdFilepath = path.resolve(filepath);
    try {
      debug(`parsers: load using cwd-relative path: "${cwdFilepath}"`);
      return require(cwdFilepath);
    } catch (err) {
      if (isModuleNotFoundError(err)) {
        debug(`parsers: retry load as module-relative path: "${filepath}"`);
        return require(filepath);
      } else {
        throw err; // rethrow
      }
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
    }
  },
  json: filepath =>
    JSON.parse(
      require('strip-json-comments')(fs.readFileSync(filepath, 'utf8'))
    )
});

/**
 * Loads and parses, based on file extension, a config file.
 * "JSON" files may have comments.
 *
 * @private
 * @param {string} filepath - Config file path to load
 * @returns {Object} Parsed config object
 */
exports.loadConfig = filepath => {
  let config = {};
<<<<<<< HEAD
  debug('loadConfig: trying to parse config at %s', filepath);
=======
  debug(`loadConfig: "${filepath}"`);
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a

  const ext = path.extname(filepath);
  try {
    if (ext === '.yml' || ext === '.yaml') {
      config = parsers.yaml(filepath);
<<<<<<< HEAD
    } else if (ext === '.js' || ext === '.cjs') {
=======
    } else if (ext === '.js') {
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
      config = parsers.js(filepath);
    } else {
      config = parsers.json(filepath);
    }
  } catch (err) {
<<<<<<< HEAD
    throw createUnparsableFileError(
      `Unable to read/parse ${filepath}: ${err}`,
      filepath
    );
=======
    throw new Error(`failed to parse config "${filepath}": ${err}`);
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
  }
  return config;
};

/**
 * Find ("find up") config file starting at `cwd`
 *
 * @param {string} [cwd] - Current working directory
 * @returns {string|null} Filepath to config, if found
 */
<<<<<<< HEAD
exports.findConfig = (cwd = utils.cwd()) => {
  const filepath = findUp.sync(exports.CONFIG_FILES, {cwd});
  if (filepath) {
    debug('findConfig: found config file %s', filepath);
=======
exports.findConfig = (cwd = process.cwd()) => {
  const filepath = findUp.sync(exports.CONFIG_FILES, {cwd});
  if (filepath) {
    debug(`findConfig: found "${filepath}"`);
>>>>>>> c8966f740229d8b8975b213b123cc1dcb439f59a
  }
  return filepath;
};
